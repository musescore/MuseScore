#!/bin/bash

# TODO: rewrite this file in a faster, more portable language (e.g. C)

# APPDIR and APPIMAGE are environment variables which are set when the user
# runs the AppImage. They won't be set if you try to run this outside of an
# AppImage, so here we set them to something sensible instead for testing.
[  "${APPDIR}"  ] || export APPDIR="$(dirname "$(readlink -f "${0}")")"
[ "${APPIMAGE}" ] || export APPIMAGE="${APPDIR}/AppRun"

libs="${APPDIR}/lib"

# Workaround for Jack library
useDummyJack() {
   export LD_LIBRARY_PATH="${APPDIR}/optional${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"
}
args=("$@")
for i in "${!args[@]}"; do
    if [ "${args[${i}]}" = "--dummy-jack" ]; then
        APPIMAGE_DUMMY_JACK=1
        unset args[$i]
    elif [ "${args[${i}]}" = "--no-dummy-jack" ]; then
        APPIMAGE_DUMMY_JACK=0
        unset args[${i}]
    fi
done
args=("${args[@]}")
if [ "${APPIMAGE_DUMMY_JACK}" = 1 ]; then
   useDummyJack
   echo "Forcing use of dummy Jack client library."
elif [ "${APPIMAGE_DUMMY_JACK}" = 0 ]; then
   echo "Forcing use of system's Jack client library."
else
   # For the record, old workaround was
   # # Based on the solution https://github.com/LMMS/lmms/pull/3958/files
   # if ! ldconfig -p | grep libjack.so.0 > /dev/null 2>&1; then
   if LC_ALL=C ldd "${APPDIR}/bin/mscore@MSCORE_INSTALL_SUFFIX@" \
   | grep "libjack.*not found" >/dev/null; then
      echo "Jack does not appear to be installed."
      echo "That's OK, we'll use a dummy Jack client library version instead."
      useDummyJack
   else
      echo "Jack appears to be installed on this system, so we'll use it."
   fi
fi

# Setting LD_LIBRARY_PATH won't override AppImage libraries, but advanced users
# can do that with APPIMAGE_LIBRARY_PATH if they really want to.
export LD_LIBRARY_PATH="${APPIMAGE_LIBRARY_PATH:+${APPIMAGE_LIBRARY_PATH}:}${libs}:${libs}/qt5/lib${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"

export QT_STYLE_OVERRIDE="GTK+" # use system font size

case "${args[0]}" in
  -h|--help|install|uninstall|remove|man|manual|manpage|check-depends|check-dependencies )
    "${APPDIR}/bin/portable-utils" "${args[@]}"
    ;;
  * )
    "${APPDIR}/bin/mscore@MSCORE_INSTALL_SUFFIX@" "${args[@]}"
    ;;
esac

exit $?
